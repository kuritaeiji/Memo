# テンプレートファイル

## セクション

| セクション名             | 値の型               | 備考                                                                                                                 |
| :----------------------- | :------------------- | :------------------------------------------------------------------------------------------------------------------- |
| AWSTemplateFormatVersion | String               | 固定値 2010-09-09                                                                                                    |
| Description              | String               | テンプレートの説明を記載                                                                                             |
| Transform                | String/List\<String> | マクロや変換を指定する（AWS::LanguageExtensions/AWS::Serverless-2016-10-31）                                         |
| Metadata                 | String               | コメントを記載/AWS::CloudFormation::Interface を設定してマネジメントコンソールのパラメータの並びを設定できる         |
| Parameters               | YAML                 | スタック作成時に指定できる値（引数）                                                                                 |
| Outputs                  | YAML                 | スタック実行後に表示する値を記載する（返り値）Fn::ImportValue で他のスタックから Export の値を参照可能               |
| Mappings                 | YAML                 | キーと名前付きの値の組み合わせを登録する（ローカル変数）                                                             |
| Conditions               | YAML                 | リソースの有無や設定条件で使用する条件を登録（条件式）疑似パラメーターとパラメーターを利用して true/false を決定する |
| Resources                | YAML                 | リソースを記載する。必須                                                                                             |
| Rules                    | YAML                 | パラメーターの値や組み合わせを検証                                                                                   |

### Metadata セクション

コメント等を記載可能

```YAML
Metadata:
  comment1: sample comment
  comment2:
    date: '2020-01-01'
    todo:
      - VPCStack
```

#### AWS::CloudFormation::Interface メタデータキー

マネジメントコンソールのパラメータのグループ/並び順/ラベルを指定可能

```YAML
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Amazon EC2 Configuration
        Parameters:
          - EC2ImageId
          - EC2InstanceType
          - EC2KeyName
```

### Parameters セクション

スタックの引数を設定可能

#### Type

| Type                                                                      | Type の値                           | 説明                                                                                        |
| :------------------------------------------------------------------------ | :---------------------------------- | :------------------------------------------------------------------------------------------ |
| String                                                                    | 文字列                              |                                                                                             |
| Number                                                                    | 数値                                | 整数または浮動小数点                                                                        |
| List\<String>/List\<Number>/List<AWS::EC2::Subnet::Id>/CommaDelimitedList | 配列                                | マネジメントコンソール/Default プロパティーには A,B,C のようにコンマ区切りで記述する        |
| AWS::EC2::VPC::Id/AWS::EC2::Subnet::Id                                    | AWS 固有のタイプ                    |                                                                                             |
| SSM パラメータータイプ                                                    | AWS::SSM::Parameter::Value\<String> | SSM パラメーターストアを参照する。パラメーターの値を取得可能。SecureString は利用できない。 |

```YAML
Parameters:
  Subnets:
    Type: List<String>
    Default: 192.168.10.0/24,192.168.11.0/24,192.168.12.0/24
    AllowedValues:
      - 192.168.10.0/24
      - 192.168.11.0/24
      - 192.168.12.0/24
  DBUser:
    type: AWS::SSM::Parameter::Value<String>
    Default: /cfn/db/user
```

### Outputs セクション

スタック実行後に表示する値を設定できる（返り値）

```YAML
Outputs:
  S3BucketName:
    Value: !Ref s3Bucket
    Description: Bucket Name
  S3BucketArn:
    Value: !GetAtt s3Bucket.Arn
    Description: Bucket Arn
```

#### Export

他のスタックに値をエクスポートできる

値をエクスポートするテンプレートファイル

```YAML
Outputs:
  S3BucketName:
    Value: !Ref s3Bucket
    Export:
      Name: s3BucketName
```

値をインポートするテンプレートファイル

```YAML
Resources:
  S3Bucket2:
    Type: AWS::S3::Bucket
    Properties:
      LoggingConfiguration:
        DestinationBucketName:
          Fn::ImportValue: s3BucketName
        LogFilePrefix: test-log/
```

エクスポートの注意点

- 利用中のエクスポートの値の更新は不可。スタックの削除も不可。
- Export 名はアカウント/リージョンで一意にする必要がある。
- Export 名には Ref や GetAtt で取得したリソース参照値は指定不可。

### Resources セクション

リソースには以下の属性を設定可能

| 属性名              | 説明                                                                         |
| :------------------ | :--------------------------------------------------------------------------- |
| 論理 ID（必須）     | cfn での論理 ID を指定する                                                   |
| Type（必須）        | AWS::EC2::Instance などのリソースの種類                                      |
| Properties          | 作成するリソースの設定値                                                     |
| DeletionPolicy      | リソース削除時の挙動を設定                                                   |
| UpdateReplacePolicy | リソース置換時の挙動を設定                                                   |
| DependsOn           | リソースを作成する順番を指定すために依存しているリソースの論理 ID を指定する |
| Metadata            | コメント                                                                     |
| Condition           | 指定した Conditions セクションの値が true の場合のみリソースを作成する       |

### ネストスタック/クロススタック/SSM パラメータでのスタック感の値の授受

### Mappings セクション

- Mappings セクションでは 3 つのキーと値の組み合わせを登録する
- Resources セクションで Fn::FindInMap を使い Mappings セクションの値を利用する

```YAML
Parameters:
  env:
    Type: String
    AllowedValues: dev,stg,pro
Mappings:
  EnvToValues:
    dev:
      taskCount: 1
      cpu: '256'
      memory: '512'
    stg:
      taskCount: 1
      cpu: '512'
      memory: '1024'
    dev:
      taskCount: 4
      cpu: '1024'
      memory: '2048'
```

### Conditions セクション

Conditions セクションに条件式を記述し、各リソースの Condition セクションでリソースの作成をする/しない等の条件を設定する

```YAML
Parameters:
  env:
    Type: String
    AllowedValues: dev,stg,pro
Conditions:
  isProd: !Equals
    - !Ref env
    - pro
Resources:
  s3Bucket4Prod:
    Type: AWS::S3::Bucket
    Condition: isProd
  s3Bucket4All:
    Type: AWS::S3::Bucket
    Properties:
      LifecycleConfiguration:
        Fn::If:
          - IsProd
          - Ref: AWS::NoValue
          - Rules:
              - Id: DeleteAfter1Month
                Status: Enabled
                ExpirationInDays: '30'
```
