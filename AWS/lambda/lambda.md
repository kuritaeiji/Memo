# Lambda 関数

- Lambda 関数は 1 コンテナで 1 つの関数しか実行しない。よって同時に 1000 のリクエストに対応する場合は 1000 個のコンテナが必要になる
- Lambda 関数はコンテナをアイドルして再利用することもある（ウォームスタート）

## APIGateway と CORS と Lambda プロキシ統合

- lambda プロキシ統合: 。APIGateway はそのまま lambda にイベントを渡し、lambda から のレスポンスをそのまま返却する。sam テンプレートの Event を使用すると lambda プロキシ統合が選択される
- lambda 非プロキシ統合: APIGateway がリクエストを加工して lambda に渡し、lambda からのスポんすを加工して返却する。

AWS::Serverless::Api の CORS 設定をすべてのパスとメソッドに対して行う（OPTIONS メソッドにも適用）。ただし lambda プロキシ統合を使用すると APIGateway は lambda からのレスポンスをそのまま返すため CORS ヘッダーが付与されない。よって lambda 関数で CORS ヘッダーを付与する必要がある。ただしプリフライトリクエストに対しては APIGateway が CORS ヘッダーを自動的にレスポンスしてくれる。

## lmabda 関数のライフサイクル

- コールドスタート（コンテナ作成） → 関数実行 → コンテナ破棄
- コールドスタート（コンテナ作成） → 関数実行 → アイドル状態 → 関数実行を繰り返す

2 つ目はウォームアップと呼ばれ lambda 関数が再利用される

## コールドスタート

コンテナを始めて実行する場合や長時間アイドル状態だったコンテナを動かす場合に発生する処理。以下の準備作業が必要なため発生する。

- コンテナの初期化
- コード読み込み
- ランタイムの初期化

### VPC へのコールドスタート

初回 VPC アクセスする場合に発生する特有の処理。Lambda 関数は VPC 外のリソースなので VPC に接続するためには VPC 内のネットワークに組み込まれる必要があるため以下の準備作業が必要。

- VPC 内に接続できる ENI の作成（オーバーレイネットワークに対応した ENI）
- IP アドレスの割り当て（VPC に割り当てられた IP アドレスの範囲）
- セキュリティーグループの適用

## RDS でなく DynamoDB が推奨される理由

- 1 コンテナに対して 1 つのデータベースコネクションが作られる。Lambda 関数はステートレスなのでコネクションプールは難しい。
- RDS への通信は VPC へのコールドスタートが発生するため。DynamoDB は VPC 内のリソースでなくパブリック AWS 上のリソースなので Lamnbda 関数が VPC のオーバーレイネットワークに組み込まれる処理が必要ない。

## ログ

- 標準出力と標準エラー出力に出力すると自動的に CloudWatch Logs に送信される
- <スタック名>-<関数名>-\<uuid>のロググループに保存される
